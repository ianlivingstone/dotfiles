# Git Configuration Architecture

**📋 Agent Rules Compliance**: This file follows Agent Rules specification using imperative statements with RFC 2119 keywords and flat bullet list format.

## Overview
The git package implements a layered configuration system that separates shared settings from machine-specific personal data using Git's native `[include]` functionality.

## Design Principles
- MUST maintain clean separation between shared configuration and machine-specific personal data
- MUST use Git's built-in `[include]` instead of shell scripting
- MUST require GPG signing for all commits and tags (security by default)
- MUST store machine-specific configs in `~/.config/git/` (XDG compliance)
- NEVER commit personal data: names, emails, signing keys stay local

## Configuration Architecture

### File Structure
```
git/
├── .gitconfig             # Shared configuration (symlinked to ~/.gitconfig)
└── .gitignore_global      # Global gitignore patterns (symlinked to ~/.gitignore_global)

~/.config/git/             # Machine-specific configuration (not in git repo)
└── machine.config         # Generated per-machine settings
```

### Configuration Layering

**Base Configuration (`git/.gitconfig`):**
```bash
# Shared settings that work across all machines
[core]
    editor = nvim
    excludesfile = ~/.gitignore_global
    autocrlf = input

[init]
    defaultBranch = main

[commit]
    gpgsign = true    # Required for all machines

[tag]
    gpgSign = true    # Required for all machines

[include]
    path = ~/.config/git/machine.config    # Machine-specific overrides
```

**Machine-Specific Configuration (`~/.config/git/machine.config`):**
```bash
# Generated by dotfiles installer per machine
[user]
    name = Your Name
    email = work@company.com        # Different per machine
    signingkey = ABC123DEF456       # Different key per machine
```

## Installation Process

### Interactive Setup
The `dotfiles.sh` installer handles machine-specific configuration:

**1. Git User Information:**
```bash
configure_git_user() {
    printf "Enter your full name for Git commits: "
    read -r git_name
    printf "Enter your email address for Git commits: "
    read -r git_email
    
    # Validation
    if [[ -z "${git_name:-}" || -z "${git_email:-}" ]]; then
        echo "❌ Name and email are required for Git"
        return 1
    fi
    
    GIT_USER_NAME="$git_name"
    GIT_USER_EMAIL="$git_email"
}
```

**2. GPG Key Detection:**
```bash
detect_gpg_keys() {
    # Scan for available GPG private keys
    local gpg_keys=($(gpg --list-secret-keys --keyid-format=long 2>/dev/null | grep '^sec' | awk '{print $2}' | cut -d'/' -f2))
    
    # Interactive selection
    echo "Select a key for Git commit signing (or 'none' to skip):"
    # ... selection logic
    
    GPG_SELECTED_KEY="${gpg_keys[$selection]}"
}
```

**3. Machine Configuration Generation:**
```bash
configure_machine_keys() {
    local machine_id="$(hostname -s)"
    local git_config="$(get_xdg_config_dir)/git/machine.config"
    
    # Create secure directory
    mkdir -p "$(dirname "$git_config")" && chmod 700 "$(dirname "$git_config")"
    
    # Generate machine-specific config
    cat > "$git_config" << EOF
# Machine-specific Git configuration for: $machine_id
# Generated by dotfiles on $(date)

[user]
    name = $GIT_USER_NAME
    email = $GIT_USER_EMAIL
    signingkey = $GPG_SELECTED_KEY
EOF
    
    chmod 600 "$git_config"
}
```

## Security Architecture

### Required GPG Signing
All commits and tags require GPG signatures:
- **Enforced globally**: Cannot be overridden per-repository
- **Machine-specific keys**: Each machine uses its own GPG key
- **Validation**: Git refuses unsigned commits/tags

### Secure File Permissions
- **Machine config**: `600` (user read/write only)
- **Config directory**: `700` (user access only)
- **Validation**: Security checks warn about improper permissions

### HTTPS Enforcement
```bash
[url "https://github.com/"]
    insteadOf = git://github.com/
[url "https://"]
    insteadOf = git://
```

## Git Configuration Settings

### Core Settings
```bash
[core]
    editor = nvim                    # Use Neovim for commit messages
    excludesfile = ~/.gitignore_global  # Global ignore patterns
    autocrlf = input                 # Consistent line endings
    pager = less -FRSX              # Better paging
```

### Diff and Merge
```bash
[diff]
    tool = vimdiff
    algorithm = histogram            # Better diff algorithm
    colorMoved = default            # Highlight moved lines

[merge]
    tool = vimdiff
    conflictstyle = diff3           # Show common ancestor in conflicts
```

### Push and Pull Behavior
```bash
[push]
    default = simple                # Push current branch to upstream
    autoSetupRemote = true          # Automatically set up remote tracking

[pull]
    rebase = true                   # Rebase instead of merge on pull
```

### Branch Management
```bash
[branch]
    autosetupmerge = always         # Set up tracking branches
    autosetuprebase = always        # Rebase tracking branches

[init]
    defaultBranch = main            # Use 'main' instead of 'master'
```

## Global Gitignore Patterns

**`git/.gitignore_global`** contains patterns for all repositories:

```bash
# Operating System
.DS_Store
Thumbs.db

# Editors
.vscode/
.idea/
*.swp
*.swo
*~

# Development
node_modules/
.env
.env.local
*.log

# Compiled binaries
*.exe
*.dll
*.so
*.dylib
```

## Multi-Machine Scenarios

### Work vs Personal Configuration

**Work Machine:**
```bash
# ~/.config/git/machine.config
[user]
    name = Your Name
    email = work@company.com
    signingkey = WORK_GPG_KEY_ID
```

**Personal Machine:**
```bash
# ~/.config/git/machine.config  
[user]
    name = Your Name
    email = personal@gmail.com
    signingkey = PERSONAL_GPG_KEY_ID
```

### Shared Base Configuration
Both machines use identical base settings:
- Same editor, diff tools, and behavior
- Same security requirements (GPG signing)
- Same global ignore patterns
- Same HTTPS enforcement

## Integration with Dotfiles System

### Stow Integration
- **Symlink management**: GNU Stow handles `.gitconfig` and `.gitignore_global`
- **Target directory**: Default target (`~/`)
- **Package validation**: Status checking ensures proper linking

### Version Requirements
- **Git version**: Minimum version defined in `versions.config`
- **Status validation**: Checks Git version compliance
- **Feature compatibility**: Ensures modern Git features are available

### Security Validation
- **Permission checks**: Validates machine config permissions during status
- **GPG validation**: Checks GPG key availability and agent status
- **Signing verification**: Ensures commits can be signed

## Development Guidelines

### Adding New Git Configuration

**1. Determine Scope:**
- **Shared setting**: Add to `git/.gitconfig`
- **Machine-specific**: Add to machine config generation logic

**2. Update Base Config:**
```bash
# For shared settings, add to git/.gitconfig
[section]
    setting = value
```

**3. Update Machine Config Generation:**
```bash
# For machine-specific settings, update configure_machine_keys()
echo "    newsetting = $MACHINE_SPECIFIC_VALUE" >> "$git_config"
```

### Testing Configuration

**Validate Config Loading:**
```bash
git config --list --show-origin  # Show all config sources
git config user.name              # Test machine-specific setting
git config core.editor            # Test shared setting
```

**Test GPG Signing:**
```bash
echo "test" | git hash-object -w --stdin  # Create test object
git tag -s test-tag HEAD                  # Test tag signing
git verify-tag test-tag                   # Verify signature
git tag -d test-tag                       # Clean up
```

### Troubleshooting

**Common Issues:**

**Missing Machine Config:**
```bash
# Check if machine config exists
ls -la ~/.config/git/machine.config

# Regenerate if needed
./dotfiles.sh install  # Re-run interactive setup
```

**GPG Signing Failures:**
```bash
# Check GPG key availability
gpg --list-secret-keys

# Test GPG agent
echo "test" | gpg --clearsign

# Check Git GPG configuration
git config user.signingkey
```

**Permission Issues:**
```bash
# Check file permissions
ls -la ~/.config/git/

# Fix permissions
chmod 700 ~/.config/git
chmod 600 ~/.config/git/machine.config
```

## Security Considerations

### Private Data Protection
- **GPG private keys**: Never copied, only key IDs stored
- **Personal information**: Only in machine-specific configs
- **Email addresses**: Different per machine, never committed to shared repo

### Network Security
- **HTTPS enforcement**: All Git operations use secure protocols
- **Certificate validation**: Git validates SSL certificates
- **No credential storage**: Rely on system credential managers

### Access Control
- **File permissions**: Machine configs readable only by user
- **Directory permissions**: Config directories secured to user-only access
- **GPG integration**: Signing keys protected by GPG agent passphrase

This architecture ensures Git configuration is both secure and maintainable while providing consistent behavior across different machines and use cases.