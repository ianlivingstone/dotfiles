# SSH Configuration Architecture

**üìã Agent Rules Compliance**: This file follows Agent Rules specification using imperative statements with RFC 2119 keywords and flat bullet list format.

## Overview
The SSH package implements a layered configuration system using SSH's native `Include` directive to separate shared settings from machine-specific identity management.

## Design Principles
- MUST use SSH's built-in `Include` instead of shell scripting
- MUST ensure each machine uses different SSH keys (identity isolation)
- MUST use modern security settings for all connections (secure defaults)
- MUST implement multiplexing and persistent connections (connection optimization)
- MUST store machine-specific configs in `~/.config/ssh/` (XDG compliance)

## Configuration Architecture

### File Structure
```
ssh/
‚îî‚îÄ‚îÄ .ssh/
    ‚îî‚îÄ‚îÄ config             # Shared SSH configuration (symlinked to ~/.ssh/config)

~/.config/ssh/             # Machine-specific configuration (not in git repo)
‚îî‚îÄ‚îÄ machine.config         # Generated per-machine identity settings
```

### Configuration Layering

**Base Configuration (`ssh/.ssh/config`):**
```bash
# Include machine-specific configuration first (highest priority)
Include ~/.config/ssh/machine.config

# Shared settings for all machines
Host *
    # Security settings
    Protocol 2
    Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
    MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com
    KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256
    
    # Connection optimization
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h-%p
    ControlPersist 600
    ServerAliveInterval 60
    ServerAliveCountMax 3
    
    # Behavior settings
    HashKnownHosts yes
    CheckHostIP yes
    StrictHostKeyChecking ask
    VerifyHostKeyDNS yes
```

**Machine-Specific Configuration (`~/.config/ssh/machine.config`):**
```bash
# Generated by dotfiles installer per machine
# Machine-specific SSH configuration for: hostname
# Generated by dotfiles on date

# Default identity files for this machine
Host *
    IdentityFile ~/.ssh/id_work_ed25519
    IdentityFile ~/.ssh/id_personal_ed25519
    IdentitiesOnly yes
```

## Installation Process

### Interactive Key Selection
The `dotfiles.sh` installer handles SSH key configuration:

**1. SSH Key Detection:**
```bash
detect_ssh_keys() {
    echo "üîç Scanning for SSH keys..."
    
    local ssh_keys=()
    for key in ~/.ssh/id_*; do
        # Check if file exists and is not a .pub file
        if [ -f "$key" ] && [ "$key" = "${key%.pub}" ]; then
            ssh_keys+=("$key")
        fi
    done
    
    if [ ${#ssh_keys[@]} -eq 0 ]; then
        echo "‚ö†Ô∏è  No SSH private keys found in ~/.ssh/"
        echo "üí° Generate keys with: ssh-keygen -t ed25519 -C 'your_email@example.com'"
        return 1
    fi
}
```

**2. Interactive Key Selection:**
```bash
# Display available keys
echo "Found SSH keys:"
local i=1
for key in "${ssh_keys[@]}"; do
    echo "  $i. $key"
    ((i++))
done

echo "Select keys to auto-load on shell startup:"
echo "  - Enter numbers comma-separated (e.g., 1,3)"
echo "  - Enter 'all' for all keys"
echo "  - Enter 'none' to skip SSH key setup"
```

**3. Machine Configuration Generation:**
```bash
configure_machine_keys() {
    local machine_id="$(hostname -s)"
    local ssh_config="$(get_xdg_config_dir)/ssh/machine.config"
    
    # Create secure directory
    mkdir -p "$(dirname "$ssh_config")" && chmod 700 "$(dirname "$ssh_config")"
    
    # Generate machine-specific config
    cat > "$ssh_config" << EOF
# Machine-specific SSH configuration for: $machine_id
# Generated by dotfiles on $(date)

# Default identity files for this machine
Host *
$(for key in "${SSH_SELECTED_KEYS[@]}"; do
    echo "    IdentityFile $key"
done)
    IdentitiesOnly yes
EOF
    
    chmod 600 "$ssh_config"
}
```

## Security Architecture

### Modern Cryptography
**Cipher Suites (in preference order):**
- `chacha20-poly1305@openssh.com` - Modern AEAD cipher
- `aes256-gcm@openssh.com` - AES-256 with GCM
- `aes128-gcm@openssh.com` - AES-128 with GCM

**Message Authentication Codes:**
- `hmac-sha2-256-etm@openssh.com` - HMAC-SHA256 with Encrypt-then-MAC
- `hmac-sha2-512-etm@openssh.com` - HMAC-SHA512 with Encrypt-then-MAC

**Key Exchange Algorithms:**
- `curve25519-sha256@libssh.org` - Modern elliptic curve
- `diffie-hellman-group-exchange-sha256` - Strong DH groups

### Identity Management
**Key Isolation:**
- Each machine uses different SSH private keys
- Keys selected during installation based on available keys
- `IdentitiesOnly yes` prevents key enumeration

**Key Types (preferred order):**
1. **Ed25519**: Modern, fast, secure (`ssh-keygen -t ed25519`)
2. **RSA 4096**: Legacy compatibility (`ssh-keygen -t rsa -b 4096`)
3. **ECDSA**: Avoid due to potential NSA backdoors

### File Permissions
- **SSH directory**: `700` (user access only)
- **Private keys**: `600` (user read/write only)
- **Public keys**: `644` (world readable)
- **Config files**: `600` (user read/write only)
- **Socket directory**: `700` (user access only)

## Connection Optimization

### SSH Multiplexing
**Connection Sharing:**
```bash
ControlMaster auto              # Enable connection sharing
ControlPath ~/.ssh/sockets/%r@%h-%p  # Socket location pattern
ControlPersist 600             # Keep connections alive for 10 minutes
```

**Benefits:**
- **Faster connections**: Reuse existing connections
- **Reduced authentication**: No need to re-authenticate
- **Lower resource usage**: Fewer TCP connections

### Keep-Alive Settings
```bash
ServerAliveInterval 60         # Send keep-alive every 60 seconds
ServerAliveCountMax 3          # Disconnect after 3 failed keep-alives
```

### Host Key Security
```bash
HashKnownHosts yes            # Hash known host names
CheckHostIP yes               # Verify host IP addresses
StrictHostKeyChecking ask     # Prompt for unknown hosts
VerifyHostKeyDNS yes         # Check DNS for host keys
```

## Multi-Machine Scenarios

### Work vs Personal Key Management

**Work Machine:**
```bash
# ~/.config/ssh/machine.config
Host *
    IdentityFile ~/.ssh/id_work_ed25519
    IdentityFile ~/.ssh/id_github_work
    IdentitiesOnly yes
```

**Personal Machine:**
```bash
# ~/.config/ssh/machine.config  
Host *
    IdentityFile ~/.ssh/id_personal_ed25519
    IdentityFile ~/.ssh/id_github_personal
    IdentitiesOnly yes
```

### Host-Specific Configurations
Can be added to machine config for specific needs:

```bash
# In ~/.config/ssh/machine.config
Host work-server
    HostName server.company.com
    User work-username
    IdentityFile ~/.ssh/id_work_ed25519
    Port 2222

Host personal-vps
    HostName my-server.example.com
    User personal-username
    IdentityFile ~/.ssh/id_personal_ed25519
```

## Integration with Dotfiles System

### Stow Integration
- **Symlink management**: GNU Stow handles SSH config linking
- **Target directory**: Default target (`~/`)
- **Package validation**: Status checking ensures proper linking

### Security Validation
- **Permission checks**: Validates SSH config and key permissions
- **Key validation**: Checks if configured keys exist and are accessible
- **Agent integration**: Coordinates with SSH agent through `agents.sh`

### Agent Management
**SSH Agent Integration (`shell/agents.sh`):**
```bash
# Check if SSH agent is running
if [[ -n "$SSH_AUTH_SOCK" ]] && ssh-add -l &>/dev/null; then
    local key_count=$(ssh-add -l 2>/dev/null | wc -l | xargs)
    echo "‚úÖ SSH Agent: Running ($key_count keys loaded)"
else
    echo "‚ùå SSH Agent: Not running"
fi
```

## Development Guidelines

### Adding Host-Specific Configuration

**1. Determine Scope:**
- **Shared setting**: Add to `ssh/.ssh/config`
- **Machine-specific**: Add to machine config generation or manual config

**2. Update Shared Config:**
```bash
# For settings that apply to all machines
Host *
    NewSharedSetting value
```

**3. Add Machine-Specific Hosts:**
```bash
# Manually add to ~/.config/ssh/machine.config
Host specific-host
    HostName actual-hostname.com
    User specific-user
    IdentityFile ~/.ssh/specific-key
```

### Testing SSH Configuration

**Validate Configuration:**
```bash
ssh -F ~/.ssh/config -T git@github.com    # Test GitHub connection
ssh -v hostname                           # Verbose connection testing
ssh -o "ControlMaster=no" hostname        # Test without multiplexing
```

**Check Configuration Parsing:**
```bash
ssh -G hostname                           # Show effective configuration
ssh -F ~/.ssh/config -G hostname         # Test specific config file
```

**Test Key Loading:**
```bash
ssh-add -l                               # List loaded keys
ssh-add ~/.ssh/id_specific               # Load specific key
ssh-add -D                               # Remove all keys
```

### Performance Testing

**Connection Timing:**
```bash
time ssh hostname exit                    # Time connection establishment
time ssh hostname echo "test"            # Time with command execution
```

**Multiplexing Verification:**
```bash
ssh -M hostname                          # Establish master connection
ssh hostname echo "shared connection"    # Use existing connection
```

## Security Considerations

### Key Management Best Practices
- **Separate keys per context**: Work, personal, servers
- **Ed25519 preferred**: Modern cryptography
- **Passphrase protection**: All private keys should be encrypted
- **Regular rotation**: Replace keys periodically

### Network Security
- **Modern protocols only**: No SSH v1, weak ciphers disabled
- **Host verification**: Known hosts checking enabled
- **DNS verification**: Additional host key validation
- **Connection limits**: Automatic disconnection on problems

### Access Control
- **File permissions**: SSH configs and keys secured to user-only access
- **Agent timeouts**: SSH agent automatically locks after inactivity
- **Key enumeration protection**: `IdentitiesOnly` prevents key probing

### Troubleshooting

**Common Issues:**

**Permission Errors:**
```bash
# Fix SSH directory permissions
chmod 700 ~/.ssh
chmod 600 ~/.ssh/config
chmod 600 ~/.ssh/id_*
chmod 644 ~/.ssh/id_*.pub
```

**Connection Multiplexing Issues:**
```bash
# Clean up stale control sockets
rm ~/.ssh/sockets/*

# Test without multiplexing
ssh -o "ControlMaster=no" hostname
```

**Key Authentication Failures:**
```bash
# Check key format and permissions
ssh-keygen -y -f ~/.ssh/id_ed25519  # Test key integrity
ssh-add ~/.ssh/id_ed25519           # Load key manually
ssh -o "IdentitiesOnly=yes" -i ~/.ssh/id_ed25519 hostname
```

This architecture provides secure, efficient SSH connectivity while maintaining clear separation between shared configuration and machine-specific identity management.